<!DOCTYPE html>
<html>
<head>
    <title>Mocha Istanbul UI</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./interface/style.css" />
    <script src="./interface/utils.js"></script>
    <script src="./interface/runner.js"></script>
    <script src="./interface/coverage.js"></script>
    <script src="./interface/watcher.js"></script>
</head>
<body>
    <div id="mocha">Loading...</div>
    <div id="error_screen" style="display: none"></div>
    <div id="coverage_report">
        <div id="coverage_report_files"></div>
        <div id="coverage_report_source"></div>
        <div id="coverage_report_close">X</div>
    </div>
    <div id="buttons">
        <div id="back_button" style="display: none">BACK</div>
        <div id="restart_button" style="display: none">RESTART</div>
        <div id="refresh_button">REFRESH</div>
    </div>
    <script>
        const app = require('electron').remote.app;
        let running = false;
        let curr_grep = '';

        CoverageReporter.init();
        Watcher.init();
        

        function setGrep(value) {
            curr_grep = value;
            mocha.grep(value);
            runTests();
        }

        function runTests () {
            if (!running) {
                back_button.style.display = 'none';
                restart_button.style.display = 'none';
                running = true;
                CoverageReporter.reset();
                Runner.run(code => {
                    if (Utils.getFlags().includes('once')) {
                        CoverageReporter.saveReport();
                        return app.process.exit(code);
                    }

                    CoverageReporter.showLink();

                    let a = document.querySelectorAll('a');
                    [].forEach.call(a, el => {
                        el.addEventListener('click', e => {

                            let grepIndex = el.href.indexOf('&grep=');
                            if (grepIndex > -1) {
                                e.preventDefault();
                                let grep = decodeURI(el.href.slice(grepIndex + 6));
                                setGrep(grep);
                            }
                        });
                    });

                    back_button.style.display = curr_grep? 'inline-block' : 'none';
                    restart_button.style.display = 'inline-block';
                    running = false;
                });
            }

            
        }

        refresh_button.onclick = function () {
            window.location.reload();
        };

        restart_button.onclick = runTests;
        Watcher.on('change', runTests);

        Runner.init(() => {
            runTests();
        });

        back_button.onclick = function () {
            setGrep('');
        }
    </script>
</body>
</html>
